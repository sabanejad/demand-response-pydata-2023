\documentclass{beamer}

% Use metropolis theme
\usetheme[progressbar=frametitle]{metropolis}
\usepackage{minted}
\usepackage{subfig}
\usepackage{hyperref}

\title{How to Use Python and Mathematical Modeling to Better Understand the Impact of Electricity Pricing on Consumption}

\date{November 2, 2023}
\author{Saba Nejad}
\institute{PyData NYC 2023}

\begin{document}
\maketitle

\section{Outline}

\begin{frame}{Overview of the Talk}
  \begin{itemize}
  \item Introduce the Problem Space; Define Terminology
  \item Introduce the Trial and the Dataset
  \item Mathematical Model
  \item Data Prep, Cleaning, Processing
  \item Results, Lessons Learned, Conclusion
  \end{itemize}
\end{frame}

\section{The Background}

\begin{frame}{The Power Grid}
  \begin{itemize}
    \item<+-> Electricity is unique in that its \textbf{storage is prohibitively costly} $\implies$ \textbf{supply must at least meet demand} at all times. 
    \item<+-> \textbf{System Operators}: Resposible for reliable delivery of electricity to consumers.
    \vspace{0.2cm}
    \begin{center}
      \includegraphics[width=0.65\textwidth]{images/iso-control-room.png}
    \end{center}
  \end{itemize}
\end{frame}

\begin{frame}{Demand Response}
  (Dynamic) Time of Use Pricing (dToU):
  \begin{itemize}
    \item Assumption 1: Demand can be shifted around.
    \item Assumption 2: Consumers are price sensitive i.e. there's correlation between demand and price. Causation?
  \end{itemize}
  \vspace{0.2cm}
  \centering
  \includegraphics[width=0.85\textwidth]{images/demand-response.png}
\end{frame}

\begin{frame}{The Fundamental Problem of Causal Inference (FPCI)}
  \begin{itemize}
    \item<+-> Assume $X \in\{0,1\}$ is a binary causal variable and $Y$ is a response variable.
    \item<+-> Assume $X$ has a causal effect on $Y$.
    \begin{itemize}
      \item $Y_0$ := the value of $Y$ for $X=0$ (untreated unit)
      \item $Y_1$ := the value of $Y$ for $X=1$ (treated unit)
    \end{itemize}
    \item<+-> $Y_0$ and $Y_1$ are \textbf{counterfactuals} of one another. We observe $Y_1$ or $Y_0$ but not both at the same time.
  \end{itemize}
\end{frame}

\begin{frame}{Other Challenges with Causal Inference}
  \begin{itemize}
    \item<+-> It's difficult to estimate the treatment effect for a unit. \\
    \indent $\implies$ analyses are done on a \textbf{population vs a unit}.
    \item<+-> When estimating treatment effect for populations, to remove bias terms, we want samples that behave similarly out of sample. \\
    \indent $\implies$ analyses are done on \textbf{random samples} of populations.
  \end{itemize}
\end{frame}

\section{The Data}

\begin{frame}{Low Carbon London Smart Meter Trial}
  \begin{itemize}
    \item<+-> Motivation: The Climate Change Act of 2008 sets the target of reducing carbon emissions to 20\% of 1990 levels by 2050.
    \item<+-> ``Dynamic": Prices were given a day ahead via the Smart Meter In Home Display or text message.
    \vspace{0.3cm}
    \begin{center}
    \includegraphics[width=0.87\textwidth]{images/day-ahead-pricing.png}
    \end{center}
  \end{itemize}
\end{frame}

\begin{frame}{Low Carbon London Smart Meter Trial}
  \begin{itemize}
    \item<+-> Data spans November 2011 and February 2014 (around 167M records)
    \item<+-> Treatment took place in the calendar year 2013
    \item<+-> Readings were taken at half hourly intervals; discrete socio-economic feature per household included in the data.
    \item<+-> dTou price bands vs static pricing model:
    \begin{table}[]
      \vspace{0.2cm}
      \centering
      \begin{tabular}{|l|l|}
        \hline
        dToU Pricing Model & Static Pricing Model \\ \hline
        High (67.20 p/kWh) & 14.228 p/kWh \\ \hline
        Normal (11.76 p/kWh) & 14.228 p/kWh \\ \hline
        Low (3.99 p/kWh) & 14.228 p/kWh \\ \hline
      \end{tabular}
    \end{table}
  \end{itemize}
\end{frame}


\begin{frame}{Low Carbon London Smart Meter Trial: Biases?}
  \textbf{The trial is double opt-in}:
  \begin{enumerate}
    \item Households opt into sharing their data with the trial at all.
    \item Some opted into the treatment group: subject to the dToU pricing model in 2013.
  \end{enumerate}
\end{frame}

\begin{frame}{Low Carbon London Smart Meter Trial: Biases?}
  The treatment group was given some incentives: 
  \begin{itemize}
    \item A guarantee that they will be reimbursed at the end of trial if they are worse off on the dToU tariff than they would have been on their previous tariff.
    \item Assurances regarding how many hours would be charged at the high price band.
    \item \textsterling100 for signing up to the dToU tariff.
    \item Another \textsterling50 for staying on the dToU tariff until the end of trial.
    \item Entry into a prize draw after completion of the post trial survey.
  \end{itemize}
\end{frame}

\begin{frame}{Low Carbon London Smart Meter Trial: Distribution?}
  \begin{figure}
    \centering
    \subfloat[\centering Trial household sample locations overlaid on the borough boundary map of Greater London. Map data from the Greater London Authority. This shows that the treatment and control group were representative samples of Greater London.]{\includegraphics[width=5cm]{images/london-geo-breakdown.png}}
    \qquad
    \subfloat[\centering The treatment and control groups were also representative socio-economic samples of Greater London.]{\includegraphics[width=5cm]{images/london-socio-breakdown.png}}
  \end{figure}
\end{frame}

\begin{frame}{Low Carbon London Smart Meter Trial: Missing Data}
  \begin{itemize}
    \item 2012: Users were still onboarding.
    \item 2013: Some users dropped out of both the treatment and the control groups
    \item 5,567 total households participated: 4,500 were in the control group, 1,100 were in the treatment group.
  \end{itemize}
  \vspace{-0.5cm}
  \includegraphics[width=1\textwidth]{images/house-count.png}
\end{frame}

\begin{frame}{Treatment vs Control Group Baselines}
  \begin{itemize}
    \item<+-> Though our groups are \textbf{geographically and socio-economically balanced}, one group opted into dToU pricing and was offered some incentives.
    \item<+-> What are some reasons the baselines might differ given what we know?
    \begin{itemize}
      \item<+-> price sensitive group opted in
      \item<+-> low consuming group opted in
      \item<+-> those households are flexible time-wise: particular jobs, hours, etc.
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{Treatment vs Control Group Baselines}
  \centering
  \includegraphics[width=1\textwidth]{images/avg-consumption-per-day-baseline.png}
  $\implies$ the two groups don't have the same baseline electricity consumption patterns.
\end{frame}

\begin{frame}{Changes from Time: 2012 vs 2013}
  \centering
  \includegraphics[width=1\textwidth]{images/yoy-changes-control-group.png}
\end{frame}

\begin{frame}{Treatment vs Control Group Baselines}
  $$
  \begin{aligned}
    & f_{2012}\left(\theta_{t r}, T, t\right) \quad \stackrel{h(t)}{\longrightarrow} \quad f_{2013}^*\left(\theta_{t r}, T, t\right) \\
    & g\left(\theta_c\right) \uparrow \quad \quad \quad \quad \quad \quad g\left(\theta_c\right) \uparrow \\
    & f_{2012}\left(\theta_c, T, t\right) \quad \stackrel{h(t)}{\longrightarrow} \quad f_{2013}\left(\theta_c, T, t\right) \\
    &
  \end{aligned}
  $$
\end{frame}

\begin{frame}{Treatment vs Control Group Baselines}
  \centering
  \includegraphics[width=0.8\textwidth]{images/group-mapping.png}
\end{frame}

\begin{frame}{Treatment vs Control Group Baselines}
  \centering
  \includegraphics[width=0.8\textwidth]{images/yoy-mapping.png}
\end{frame}

\begin{frame}{Treatment Effective?}
  If we look at percent change without normalizing the baselines the treatment was effective.
\end{frame}

\section{The Math}

\begin{frame}{Mathematical Model}
  Consider the following segmentation of the data.
  \begin{itemize}
    \item $\alpha_y$ := control group's consumption matrix during year $y$
    \item $\beta_y$ := treatment group's consumption matrix during year $y$
  \end{itemize}
\end{frame}

\begin{frame}{Mathematical Model}
  \begin{table}[h!]
  \centering
    \begin{tabular}{|p{3cm}|p{3.5cm}|p{3.5cm}|}
        \hline
        Year & Control Group & Treatment Group \\
        \hline
        2011 & $\alpha_{2011}$ & $\beta_{2011}$ \\
        2012 & $\alpha_{2012}$ & $\beta_{2012}$ \\
        2013 & $\alpha_{2013}$ & $\beta_{2013}$* \\
        2014 & $\alpha_{2014}$ & $\beta_{2014}$ \\
        \hline
    \end{tabular}
  \end{table}
\end{frame}

\begin{frame}{Mathematical Model}
  \begin{align}
    \begin{split}
        \alpha_{2012} X &= \beta_{2012} \\
        \alpha_{2013} X &= \hat\beta_{2013} \\
        \Delta\mbox{treatment} &= \beta_{2013} - \hat\beta_{2013}
    \end{split}
  \end{align}
\end{frame}

\begin{frame}{Other Clustering?}
  I used different clustering methods to cluster houses in this data set based on the control groupâ€™s consumption pre-intervention: k-means clustering, PCA3, TSNE4. I also tried clustering on the frequency responses which I found fast Fourier trans- form. PCA, TSNE, and Agglomerative clustering on the resulting data set was also inconclusive. This is reason for sticking to the pre-existing socio-economic clusters.
\end{frame}


\section{The Analysis}

\begin{frame}
  Assume matrix $\alpha^{t \times n_c}$ contains control group data, and $\beta^{t \times n_t}$ contains treatment group data. Where $t = 365 \times 48 = 17520$, $n_c$ is the number of households in the control group and $n_t$ is the number of households in the treatment group.
  \begin{align}
    \begin{split}
      \overline{\beta^m_{2012}} &= a \times \overline{\alpha^m_{2012}} + b \\
      \overline{\hat{\beta}^m_{2013}} &= a \times \overline{\alpha^m_{2013}} + b \\
      \overline{\Delta\mbox{treatment}} &= \overline{\beta^m_{2013}} - \overline{\hat{\beta}^m_{2013}}
    \end{split}
  \end{align}
\end{frame}

\begin{frame}{Data Prep, Cleaning, Processing}
  \includegraphics[width=0.95\textwidth]{images/lcl-raw-files.png}
\end{frame}

\begin{frame}{Data Prep, Cleaning, Processing}

\end{frame}

\begin{frame}{Data Prep, Cleaning, Processing}
  \centering
  \includegraphics[width=1.1\textwidth]{images/dow-socio.png}
\end{frame}

\section{The Conclusion}

\begin{frame}{Lessons Learned}
  \begin{itemize}
    \item<+-> KYD: know your data: learn how it was collected, its biases, shortcomings, feature space, problem space.
    \item<+-> Before diving into fitting a model to your data, it's important to base your analysis on some mathematical model
    \vspace{1cm}
    \begin{center}
    \includegraphics[width=0.8\textwidth]{images/reality-model-data.png}
    \end{center}
  \end{itemize}
\end{frame}

\begin{frame}{What Did We Learn?}
  \begin{itemize}
    \item<+-> A little bit about electricity markets?
    \item<+-> Causal analysis.
    \item<+-> How to break down your data to match the mathematical model at hand.
    \item<+-> Questions to ask before analysis:
    \begin{itemize}
      \item<+-> How was the data collected? 
      \item<+-> What biases are present?
      \item<+-> How does that impact your analysis and results?
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{Thank You}
  \begin{itemize}
  \item \url{https://github.com/sabanejad}
  \item \url{https://www.linkedin.com/in/sabanejad/}
  \end{itemize}
\end{frame}

% \section{Appendix}

% \begin{frame}{The Fundamental Problem of Causal Inference (FPCI)}
%   \begin{itemize}
%     \item<+-> Assume $X \in\{0,1\}$ is a binary causal variable and $Y$ is a response variable (which may be continuous).
%     \item<+-> Assume $X$ has a causal effect on $Y$, this implies that the value of $Y$ we observe depends on the value of $X$.
%     \item<+-> We can define $Y_0$ and $Y_1$ as the values that $Y$ would take if $X$ were equal to 0 and 1 respectively.
%     \item<+-> $Y_0$ and $Y_1$ are counterfactuals of one another. Both can never be observed at the same time.
%     \begin{itemize}
%       \item $Y_i$ := the outcome of interest for unit $i$
%       \item $Y_0$ := the value of $Y_i$ for $X=0$ (untreated unit)
%       \item $Y_1$ := the value of $Y_i$ for $X=1$ (treated unit)
%     \end{itemize}
%   \end{itemize}
% \end{frame}


% \begin{frame}{The Fundamental Problem of Causal Inference (FPCI)}
%   \begin{itemize}
%     \item<+-> Assume that units are all alike, so $Y_{0 i} \equiv Y_0$ and $Y_{1 i} \equiv Y_1$.
%     \item<+-> The causal effect of $X_i$ on $Y_i$ is $T=Y_1-Y_0$, where $T$ stands for Treatment Effect.
%     \item<+-> \textit{But what's the issue here?}
%     \item<+-> We never observe $Y_1-Y_0$ for a single unit $i$. Instead, we observe
%     $$
%     Y_i=Y_{1 i} X_i+Y_{0 i}\left(1-X_i\right)
%     $$
%     That is, we observe $Y_1$ or $Y_0$ but not both.
%   \end{itemize}
% \end{frame}

% \begin{frame}{Solutions Around FPCI}
%   \begin{enumerate}
%     \item<+-> Temporal Stability \& Causal Transience
%     \item<+-> Unit Homogeneity
%     \item<+-> Analyze Populations Instead of Units
%   \end{enumerate}
% \end{frame}

% \begin{frame}{Solutions Around FPCI for this Trial}
%   \begin{enumerate}
%     \item Temporal Stability \& Causal Transience {\color{red}{X}}
%     \item Unit Homogeneity {\color{red}{X}}
%     \item Estimate causal effects for populations rather than units {\color{green}{\checkmark}}
%   \end{enumerate}
% \end{frame}

% \begin{frame}{Estimate Causal Effects for Populations Rather than Units}
%   \begin{itemize}
%     \item<+-> Causal Effect for Unit $i$: $T_i=Y_{1 i}-Y_{0 i}$
%     \begin{itemize}
%       \item \textit{We can't estimate this. Why?}
%     \end{itemize}
%     \item<+-> Average Treatment Effect for the Treated (ATT): $T^*=E\left[Y_1-Y_0 \mid X=1\right]$
%     \item<+-> Average Treatment Effect (ATE): $T^{\dagger}=E\left[Y_1-Y_0\right]$
%     \item<+-> \textit{ATE is treatment effect assuming entire population is treated.}
%       \begin{itemize}
%         \item \textit{What's an example?}
%         \item \textit{Which of the two is more important? But how do we estimate it?}
%       \end{itemize}
%   \end{itemize}
% \end{frame}


% \begin{frame}{Estimate Causal Effects for Populations Rather than Units}
%   To make things more complicated, let's make another estimator.
%   \begin{enumerate}
%     \item<+-> $\tilde{T}=E[Y \mid X=1]-$ $E[Y \mid X=0]$
%   \end{enumerate}
%   Is $\tilde{T}$ a good estimator of $T^*$? What is it estimating?
%   What change can we make to our population to make this a good estimator?
% \end{frame}

% \begin{frame}{Estimate Causal Effects for Populations Rather than Units}
%   \begin{itemize}
%     \item<+-> Assume your treatment and control group had the same expected baseline behavior, and the same counterfactual expected behavior.
%     $$
%     \begin{aligned}
%     & E\left[Y_1 \mid X=1\right]=E\left[Y_1 \mid X=0\right] \\
%     & E\left[Y_0 \mid X=1\right]=E\left[Y_0 \mid X=0\right]
%     \end{aligned}
%     $$
%     \item<+-> Let's revisit $$ \begin{aligned}
%       T^* & = E\left[Y_1 \mid X=1\right]-E\left[Y_0 \mid X=1\right] \\
%           & = E\left[Y_1 \mid X=1\right]-E\left[Y_0 \mid X=0\right] 
%     \end{aligned} $$
%   \end{itemize}
% \end{frame}

% \begin{frame}{Estimate Causal Effects for Populations Rather than Units}
%   \begin{itemize}
%     \item<+-> but what if they aren't exactly the same, this would often hold in the case of an actual treatment. In other words there's a reason for the treatment:
%     \item<+-> $$
%     \begin{aligned}
%     & E\left[Y_1 \mid X=1\right]>E\left[Y_1 \mid X=0\right] \\
%     & E\left[Y_0 \mid X=1\right]>E\left[Y_0 \mid X=0\right] .
%     \end{aligned}
%     $$
%     \item<+-> ... let's bring back $\tilde{T}$. 
%   \end{itemize}
% \end{frame}

% \begin{frame}{Estimate Causal Effects for Populations Rather than Units}
%   So, if we calculated the contrast $\tilde{T}=E[Y \mid X=1]-E[Y \mid X=0]$ for this unbalanced group, what would we get?
%   $$
%   \begin{aligned}
%   E\left[Y_1 \mid X=1\right]-E\left[Y_0 \mid X=0\right] & =\underbrace{E\left[Y_1 \mid X=1\right]-E\left[Y_0 \mid X=1\right]}_{T^*} \\
%   & +\underbrace{\left\{E\left[Y_0 \mid X=1\right]-E\left[Y_0 \mid X=0\right]\right\}}_{\text {Bias }} .
%   \end{aligned}
%   $$
%   (Go to whiteboard and do the rest)
% \end{frame}

% % Notice that our substitution above of $E\left[Y_0 \mid X=1\right]$ for $E\left[Y_0 \mid X=0\right]$ is justified by the assumption of treatment-control balance in equation (1). If the subjects who didn't receive the treatment are just like those who did but for not having received the treatment, then the contrast between the treated and untreated groups provides an unbiased estimate of the causal effect of the treatment on the treated group (ATT).
% % - Returning to our invalid estimator $\tilde{T}$, let's ask how likely is it that the counterfactual outcomes would be balanced among a set of people selected from the population according to whether or not they are currently receiving the treatment. It does not take a great leap of logic to hypothesize that the patients receiving the cholesterol drug are more likely to be suffering from high cholesterol than those who are not taking the drug. This would imply that:


% % In words, patients receiving the drug are more likely to suffer from high cholesterol whether or not they are receiving the drug (presumably, they are receiving the drug specifically because they were diagnosed with high cholesterol).


% % The first term on the right-hand side of this equation is the true, causal effect of the cholesterol treatment on those who take it (the ATT). The second term is the potential bias that


% \begin{frame}{Potential Outcomes Framework (Rubin-Neyman Causal Model)}
%   Each household $x_i$ has two potential outcomes:
%   \begin{itemize}
%     \item $Y_0\left(x_i\right)$ is the potential outcome had the unit not been treated (static pricing model): ``control outcome"
%     \item $Y_1\left(x_i\right)$ is the potential outcome had the unit been treated (dToU pricing model): ``treated outcome"
%   \end{itemize}
%   - Conditional average treatment effect for unit $i$ :
%   $$
%   \operatorname{CATE}\left(x_i\right)=\mathbb{E}_{Y_1 \sim p\left(Y_1 \mid x_i\right)}\left[Y_1 \mid x_i\right]-\mathbb{E}_{Y_0 \sim p\left(Y_0 \mid x_i\right)}\left[Y_0 \mid x_i\right]
%   $$
%   - Average Treatment Effect:
%   $$
%   A T E:=\mathbb{E}\left[Y_1-Y_0\right]=\mathbb{E}_{x \sim p(x)}[\operatorname{CATE}(x)]
%   $$
% \end{frame}

% \begin{frame}{Mathematical Model}
% \begin{itemize}
%   \item Fundamental Problem of Causal Inference: Both outcomes can't be observed for the same household $x_i$.
%   \begin{itemize}
%     \item Observed factual outcome:
%     $$
%     y_i=t_i Y_1\left(x_i\right)+\left(1-t_i\right) Y_0\left(x_i\right)
%     $$
%     \item Unobserved counterfactual outcome:
%     $$
%     y_i^{C F}=\left(1-t_i\right) Y_1\left(x_i\right)+t_i Y_0\left(x_i\right)
%     $$
%   \end{itemize}
%   \item Solution? Approximate the counterfactual eg close enough to random sample: minimum wage problem, NJ and east PA, Card \& Krueger, 1994.
% \end{itemize}
% \end{frame}

% \begin{frame}
%   David Card minimum wage paper: \url{https://davidcard.berkeley.edu/papers/njmin-aer.pdf}
%   LCL Experiment \url{https://data.london.gov.uk/dataset/smartmeter-energy-use-data-in-london-households}
% \end{frame}

\end{document}